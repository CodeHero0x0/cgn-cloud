<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cgn.dataservice.dao.DataServiceApiConfigDao">
    <update id="increaseRequestedTimes">
        UPDATE data_service_api_config
        SET requested_times=requested_times + 1
        WHERE id = #{id}
    </update>
    <update id="increaseRequestedSuccessTimes">
        UPDATE data_service_api_config
        SET requested_success_times=requested_success_times + 1
        WHERE id = #{id}
    </update>
    <update id="increaseRequestedFailedTimes">
        UPDATE data_service_api_config
        SET requested_failed_times=requested_failed_times + 1
        WHERE id = #{id}
    </update>

    <select id="getAuthList" resultType="com.cgn.dataservice.entity.DataServiceApiConfigEntity">
        SELECT dsac.*,
        dsaa.id AS auth_id
        FROM data_service_api_config dsac
        LEFT JOIN data_service_api_auth dsaa ON dsac.id = dsaa.api_id
        AND dsaa.deleted = 0
        WHERE dsac.group_id = #{groupId}
        AND dsac.previlege = 1
        AND dsac.deleted = 0
        <if test="name != null and name.trim() != ''">
            AND dsac.name LIKE "%"#{name}"%"
        </if>
        <if test="path != null and path.trim() != ''">
            AND dsac.path LIKE "%"#{path}"%"
        </if>
        <if test="contentType != null and contentType.trim() != ''">
            AND dsac.content_type = #{content_type}
        </if>
        <if test="status != null">
            AND dsac.status = #{status}
        </if>
        <if test="sqlDbType != null">
            AND dsac.sql_db_type = #{sqlDbType}
        </if>
        <if test="databaseId != null">
            AND dsac.database_id = #{databaseId}
        </if>
        <if test="previlege != null">
            AND dsac.previlege = #{previlege}
        </if>
        <if test="openTrans != null">
            AND dsac.open_trans = #{openTrans}
        </if>
        ORDER BY dsac.create_time DESC,dsac.id DESC
    </select>
    <select id="getResourceList" resultType="com.cgn.dataservice.entity.DataServiceApiConfigEntity">
        SELECT dsac.*
        FROM data_service_api_config dsac
        INNER JOIN data_assets_resource_mount darm ON dsac.id = darm.mount_id
        WHERE darm.mount_type = 2
        AND darm.resource_id = #{resourceId}
        AND dsac.deleted = 0
        <if test="name != null and name.trim() != ''">
            AND dsac.name LIKE "%"#{name}"%"
        </if>
        <if test="path != null and path.trim() != ''">
            AND dsac.path LIKE "%"#{path}"%"
        </if>
        <if test="contentType != null and contentType.trim() != ''">
            AND dsac.content_type = #{contentType}
        </if>
        <if test="status != null">
            AND dsac.status = #{status}
        </if>
        <if test="sqlDbType != null">
            AND dsac.sql_db_type = #{sqlDbType}
        </if>
        <if test="databaseId != null">
            AND dsac.database_id = #{databaseId}
        </if>
        <if test="previlege != null">
            AND dsac.previlege = #{previlege}
        </if>
        <if test="openTrans != null">
            AND dsac.open_trans = #{openTrans}
        </if>
        ORDER BY dsac.create_time DESC,dsac.id DESC
    </select>


</mapper>
